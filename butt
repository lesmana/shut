#! /bin/sh

prefix="test"
donotruntests=false

handle_args() {
  while getopts "n" "opt"; do
    case "$opt" in
      n) donotruntests=true;;
      *) exit 1;;
    esac
  done
  shift $(($OPTIND - 1))
  if [ $# -ge 1 ]; then
    prefix="$@"
  fi
}

print_pass() {
  :
}

print_fail() {
  sed 's/^/  /'
}

runtest() {
  filename=$1
  output="$("$filename" 2>&1)"
  success=$?
  if [ $success -eq 0 ]; then
    print_pass
  else
    echo "$filename"
    echo "$output" | print_fail
  fi
  return $success
}

collecttests() {
  find -L . -maxdepth 1 -type f -name "$prefix*" | sort
}

runtests() {
  fail=0

  while read filename; do
    if $donotruntests; then
      echo "$filename"
    else
      runtest "$filename" || fail=1
    fi
  done

  return $fail
}

main() {
  handle_args "$@"
  collecttests | runtests
}

main "$@"
