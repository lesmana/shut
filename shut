#! /bin/sh

default_pattern="test"

config_shiftargv=0
config_donotruntests=false
config_verbose=false
config_shutdir="shutdir"
config_keep=false
config_split=false
config_quiet=false
config_tail=10
SHUT_PWD=$PWD

configfromargv() {
  # this function expects "$@" as argument
  argc=$#
  while [ $# -ge 1 ]; do
    arg=$1
    case "$arg" in
      -d) shift ; config_shutdir="$1" ;;
      -k) config_keep=true ;;
      -n) config_donotruntests=true ;;
      -v) config_verbose=true ;;
      -x) config_split=true ;;
      -q) config_quiet=true ;;
      -t) shift ; config_tail="$1" ;;
      --) shift ; break ;;
      -*) echo "argv error: $1" ; exit 2 ;;
       *) break ;;
    esac
    shift
  done
  config_shiftargv=$((argc - $#))
}

setup() {
  config_fullshutdir=$(readlink -f "$config_shutdir")
  if $config_donotruntests; then
    whatiswork_func=workisprinttestnames
  else
    whatiswork_func=workisruntests
  fi
  if $config_split; then
    runtestsaveoutput_func=runtestsaveoutputsplit
    printbody_func=printbodysplit
  else
    runtestsaveoutput_func=runtestsaveoutputmerge
    printbody_func=printbodymerge
  fi
  if $config_verbose; then
    printreportpass_func=actualprintreport
    printreportfail_func=actualprintreport
  elif $config_quiet; then
    printreportpass_func=true
    printreportfail_func=true
  else
    printreportpass_func=true
    printreportfail_func=actualprintreport
  fi
}

collecttestnames() {
  # this function expects "$@" as argument
  # the same "$@" as the function configfromargv
  shift "$config_shiftargv"
  if [ $# -eq 0 ]; then
    set -- "$default_pattern"
  fi
  print="-false"
  for pattern in "$@"; do
    if [ -f "$SHUT_PWD/$pattern" ]; then
      print="$print -o -type f -executable -path \*/$pattern"
    elif [ -d "$SHUT_PWD/$pattern" ]; then
      print="$print -o -type f -executable -path \*/$pattern/\*"
    else
      print="$print -o -type f -executable -regex .\*/$pattern[^/]\*"
    fi
  done
  find "$SHUT_PWD" -type d -name "$config_shutdir" -prune -o \
        \( $print \) -printf "./%P\n" | sort
}

deleteshutdir() {
  if [ ! -e "$config_fullshutdir" ]; then
    return
  fi
  if $config_keep; then
    echo "name exists: $config_shutdir" >&2
    echo "will not overwrite" >&2
    return 2
  fi
  if [ ! -d "$config_fullshutdir" ]; then
    echo "is not shutdir: $config_shutdir" >&2
    echo "will not overwrite" >&2
    return 2
  fi
  rm -rf "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error deleting $config_fullshutdir"
    echo "cannot continue"
    return 3
  }
}

runtest() {
  testname=$1
  fulltestname="$SHUT_PWD/${testname#./}"
  (
    export SHUT_PWD
    export SHUT_TEST="$fulltestname"
    export SHUT_TESTPWD="$PWD"
    exec 0>&- 3>&- 4>&-
    "$fulltestname"
  )
}

runtestsaveexitstatus() {
  testname=$1
  runtest "$testname"
  exitstatus=$?
  echo $exitstatus > ../exitstatus
}

runtestsaveoutputsplit() {
  testname=$1
  runtestsaveexitstatus "$testname" > ../stdout 2> ../stderr
}

runtestsaveoutputmerge() {
  testname=$1
  runtestsaveexitstatus "$testname" > ../output 2>&1
}

runtestinworkdir() {
  testname=$1
  mkdir -p workdir > /dev/null 2>&1 || {
    echo "error creating workdir"
    return 3
  }
  (
    cd workdir > /dev/null 2>&1 || {
      echo "error changing directory to workdir"
      return 3
    }
    $runtestsaveoutput_func "$testname"
  )
}

printbodysplit() {
  echo "stdout:"
  cat stdout | tail -n $config_tail | sed 's/^/  /'
  echo "stderr:"
  cat stderr | tail -n $config_tail | sed 's/^/  /'
}

printbodymerge() {
  echo "output:"
  cat output | tail -n $config_tail | sed 's/^/  /'
}

actualprintreport() {
  testname=$1
  testexitstatus=$2
  statestring=$3
  echo "================"
  echo "$testname"
  echo "----------------"
  $printbody_func
  echo "----------------"
  echo "exitstatus: $testexitstatus"
  echo "$statestring $testname"
  echo "----------------"
}

printreport() {
  testname=$1
  exitstatus=$(cat exitstatus)
  if [ $exitstatus -eq 0 ]; then
    echo "$testname" >&3
    printreport_func=$printreportpass_func
    statestring="PASS"
  else
    echo "$testname" >&4
    printreport_func=$printreportfail_func
    statestring="FAIL"
  fi
  $printreport_func "$testname" $exitstatus $statestring
}

runtestandprintreport() {
  testname=$1
  runtestinworkdir "$testname" || {
    return
  }
  printreport "$testname"
}

runtestintestdir() {
  testname=$1
  testdir="$testname.dir"
  mkdir -p "$testdir" > /dev/null 2>&1 || {
    echo "error creating testdir"
    return 3
  }
  (
    cd "$testdir" > /dev/null 2>&1 || {
      echo "error changing directory to testdir"
      return 3
    }
    runtestandprintreport "$testname"
  )
}

runtestandreporterror() {
  testname=$1
  runtestintestdir "$testname" || {
    echo "$testname" >&4
  }
}

runtests() {
  while read testname; do
    runtestandreporterror "$testname" 3>> ../pass 4>> ../fail 5>> ../error
  done < ../tests
}

runtestsinlogdir() {
  mkdir -p logdir > /dev/null 2>&1 || {
    echo "error creating logdir"
    return 3
  }
  (
    cd logdir > /dev/null 2>&1 || {
      echo "error changing directory to logdir"
      return 3
    }
    runtests
  )
}

printfails() {
  echo "failed tests:"
  cat fail
  echo "----------------"
}

printcounts() {
  wc -l tests pass fail | {
    read runcount ignorefilename
    read passcount ignorefilename
    read failcount ignorefilename
    read ignoretotal
    printf "run: %d pass: %d fail: %d\n" "$runcount" "$passcount" "$failcount"
  }
}

printsummary() {
  if [ -s fail ]; then
    printfails
  fi
  printcounts
}

runtestsandprintsummary() {
  runtestsinlogdir || {
    return
  }
  printsummary
  [ ! -s fail ] # exitstatus based on fail empty or not
}

runtestsinshutdir() {
  mkdir -p "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error creating directory $config_fullshutdir"
    echo "cannot continue"
    return 3
  }
  cp tests "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error copying tests to $config_fullshutdir"
    echo "cannot continue"
    return 3
  }
  (
    cd "$config_fullshutdir" > /dev/null 2>&1 || {
      echo "error changing directory to $config_fullshutdir"
      echo "cannot continue"
      return 3
    }
    runtestsandprintsummary
  )
}

workisruntests() {
  deleteshutdir || {
    return
  }
  runtestsinshutdir
}

workisprinttestnames() {
  cat tests
  count=$(wc -l < tests)
  echo "would run: $count"
}

collectnamesandwork() {
  collecttestnames "$@" > tests
  test -s tests || {
    echo "no tests found"
    return 2
  }
  $whatiswork_func
}

workintempdir() {
  shuttempdir=$(mktemp -d --tmpdir shuttempdir.XXX 2> /dev/null) || {
    echo "error creating tempdir" >&2
    echo "cannot continue" >&2
    return 3
  }
  (
    cd "$shuttempdir" > /dev/null 2>&1 || {
      echo "failed changing directory to $shuttempdir"
      echo "cannot continue"
      return 3
    }
    collectnamesandwork "$@"
  )
  exitstatus=$?
  rm -rf "$shuttempdir"
  return $exitstatus
}

main() {
  configfromargv "$@"
  setup
  workintempdir "$@"
}

main "$@"
