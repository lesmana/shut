#! /bin/sh

default_pattern="test"

config_donotruntests=false
config_verbose=false
config_shutdir="shutdir"
config_keep=false
config_split=false
config_quiet=false
config_tail=10
SHUT_PWD="$PWD"

# -----------------------------------------------------------------------------
runtest() {
  local fulltestname="$1"
  (
    export SHUT_PWD
    export SHUT_TEST="$fulltestname"
    exec 0<&- 1>&3 3>&- 2>&4 4>&-
    "$fulltestname"
  )
}

runtestsaveexitstatus() {
  local fulltestname="$1"
  runtest "$fulltestname"
  local exitstatus=$?
  echo "$exitstatus" > ../exitstatus
  echo "$exitstatus"
}

runtestsaveoutputsplit() {
  local fulltestname="$1"
  runtestsaveexitstatus "$fulltestname" 3> ../stdout 4> ../stderr
}

runtestsaveoutputmerge() {
  local fulltestname="$1"
  runtestsaveexitstatus "$fulltestname" 3> ../output 4>&3
}

# -----------------------------------------------------------------------------
mkdir_workdir() {
  mkdir workdir > /dev/null 2>&1 || {
    echo "error creating workdir" >&4
    return 3
  }
}

cd_workdir() {
  cd workdir > /dev/null 2>&1 || {
    echo "error changing directory to workdir" >&4
    return 3
  }
}

runtestinworkdir() {
  local fulltestname="$1"
  mkdir_workdir || return $?
  (
    cd_workdir || return $?
    $runtestsaveoutput_func "$fulltestname"
  )
}

# -----------------------------------------------------------------------------
printheader() {
  local statusstring="$1"
  local testname="$2"
  echo "================"
  echo "$statusstring $testname"
}

printexitstatus() {
  local exitstatus="$1"
  echo "exitstatus: $exitstatus"
}

printbodysplit() {
  echo "stdout:"
  cat stdout | tail -n "$config_tail" | sed 's/^/  /'
  echo "stderr:"
  cat stderr | tail -n "$config_tail" | sed 's/^/  /'
}

printbodymerge() {
  echo "output:"
  cat output | tail -n "$config_tail" | sed 's/^/  /'
}

printreportpass() {
  local testname="$1"
  printheader "PASS" "$testname"
  $printbody_func
}

printreportfail() {
  local testname="$1"
  local exitstatus="$2"
  printheader "FAIL" "$testname"
  printexitstatus "$exitstatus"
  $printbody_func
}

printreport() {
  local testname="$1"
  local exitstatus="$2"
  if [ "$exitstatus" -eq 0 ]; then
    echo "$testname" >> "$config_fullshutdir/testspass"
    $printreportpass_func "$testname"
  else
    echo "$testname" >> "$config_fullshutdir/testsfail"
    $printreportfail_func "$testname" "$exitstatus"
  fi
}

runtestandprintreport() {
  local testname="$1"
  local fulltestname="$2"
  local exitstatus
  exitstatus="$(runtestinworkdir "$fulltestname")" || return $?
  printreport "$testname" "$exitstatus"
}

# -----------------------------------------------------------------------------
runtestifexecutable() {
  local testname="$1"
  local fulltestname="$SHUT_PWD/${testname#./}"
  [ -x "$fulltestname" ] || {
    echo "not found or not executable: $testname" >&4
    return 3
  }
  runtestandprintreport "$testname" "$fulltestname"
}

# -----------------------------------------------------------------------------
runtestcatchtunhandlederror() {
  local unhandled="$config_tempdir/runtesterrorunhandled"
  runtestifexecutable "$@" 2> "$unhandled" || {
    local exitstatus=$?
    if [ -s "$unhandled" ]; then
      echo "unhandled error:" >&4
      cat "$unhandled" >&4
    fi
    return "$exitstatus"
  }
}

runtestcatchthandlederror() {
  local handled="$config_tempdir/runtesterrorhandled"
  runtestcatchtunhandlederror "$@" 4> "$handled" || {
    local exitstatus=$?
    if [ -s "$handled" ]; then
      printheader "ERROR" "$testname" >&2
      cat "$handled" >&2
    fi
    return "$exitstatus"
  }
}

runtestcatchterror() {
  runtestcatchthandlederror "$@" 2>&1 || {
    echo "$testname" >> "$config_fullshutdir/testserror"
  }
}

# -----------------------------------------------------------------------------
mkdir_testdir() {
  local testdir="$1"
  mkdir -- "$testdir" > /dev/null 2>&1 || {
    echo "error creating testdir: $testdir" >&3
    return 3
  }
}

cd_testdir() {
  local testdir="$1"
  cd -- "$testdir" > /dev/null 2>&1 || {
    echo "error changing directory to testdir: $testdir" >&3
    return 3
  }
}

runtestintestdir() {
  local count="$1"
  local testname="$2"
  local testdir="test$count"
  mkdir_testdir "$testdir" || return $?
  (
    cd_testdir "$testdir" || return $?
    runtestcatchterror "$testname"
  )
}

# -----------------------------------------------------------------------------
runtests() {
  touch testspass testsfail testserror
  local testname
  nl -n rz testsfound | while read -r count testname; do
    runtestintestdir "$count" "$testname"
  done
}

# -----------------------------------------------------------------------------
printlist() {
  local listname="$1"
  local filename="$2"
  echo "================"
  echo "$listname:"
  cat "$filename"
}

printcounts() {
  wc -l testsfound testspass testsfail testserror | {
    read -r runcount ignorefilename
    read -r passcount ignorefilename
    read -r failcount ignorefilename
    read -r errorcount ignorefilename
    read -r ignoretotal
    echo "================"
    printf "run: %d pass: %d fail: %d error: %d\n" \
          "$runcount" "$passcount" "$failcount" "$errorcount"
  }
}

printsummary() {
  if [ -s testsfail ]; then
    printlist fail testsfail
  fi
  if [ -s testserror ]; then
    printlist error testserror
  fi
  printcounts
}

determineexitstatus() {
  [ ! -s testsfail ] && [ ! -s testserror ] # exitstatus based on list empty or not
}

runtestsandprintsummary() {
  runtests || return $?
  printsummary
  determineexitstatus
}

# -----------------------------------------------------------------------------
rm_shutdir() {
  if [ ! -e "$config_fullshutdir" ]; then
    return
  fi
  if $config_keep; then
    echo "name exists: $config_shutdir" >&3
    echo "will not overwrite" >&3
    return 2
  fi
  if [ ! -d "$config_fullshutdir" ]; then
    echo "is not shutdir: $config_shutdir" >&3
    echo "will not overwrite" >&3
    return 2
  fi
  rm -r -- "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error deleting $config_fullshutdir" >&3
    echo "cannot continue" >&3
    return 3
  }
}

mkdir_shutdir() {
  mkdir -p -- "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error creating directory $config_fullshutdir" >&3
    echo "cannot continue" >&3
    return 3
  }
}

cp_tests_shutdir() {
  cp -- testsfound "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error copying testsfound to $config_fullshutdir" >&3
    echo "cannot continue" >&3
    return 3
  }
}

cd_shutdir() {
  cd -- "$config_fullshutdir" > /dev/null 2>&1 || {
    echo "error changing directory to $config_fullshutdir" >&3
    echo "cannot continue" >&3
    return 3
  }
}

runtestsinshutdir() {
  rm_shutdir || return $?
  mkdir_shutdir || return $?
  cp_tests_shutdir || return $?
  (
    cd_shutdir || return $?
    runtestsandprintsummary
  )
}

# -----------------------------------------------------------------------------
printtestnames() {
  cat testsfound
  local count=$(wc -l < testsfound)
  echo "================"
  echo "would run: $count"
}

# -----------------------------------------------------------------------------
workiftestsfound() {
  [ -s testsfound ] || {
    echo "no tests found"
    return 2
  }
  $work_func # runtestsinshutdir or printtestnames
}

# -----------------------------------------------------------------------------
collecttestnames() {
  if [ ! -s patterns ]; then
    echo "$default_pattern" > patterns
  fi
  local pattern
  local print="-false"
  while read -r pattern; do
    if [ -f "$SHUT_PWD/$pattern" ]; then
      print="$print -o -type f -executable -path \*/$pattern"
    elif [ -d "$SHUT_PWD/$pattern" ]; then
      print="$print -o -type f -executable -path \*/$pattern/\*"
    else
      print="$print -o -type f -executable -regex .\*/$pattern[^/]\*"
    fi
  done < patterns
  find "$SHUT_PWD" -type d -name "$config_shutdir" -prune -o \
        \( $print \) -printf "./%P\n" | sort > testsfound
}

collectnamesandwork() {
  collecttestnames
  workiftestsfound
}

# -----------------------------------------------------------------------------
configfromargv() {
  # this function expects "$@" as argument
  local arg
  while [ $# -ge 1 ]; do
    arg="$1"
    case "$arg" in
      -d) shift ; config_shutdir="$1" ;;
      -k) config_keep=true ;;
      -n) config_donotruntests=true ;;
      -v) config_verbose=true ;;
      -x) config_split=true ;;
      -q) config_quiet=true ;;
      -t) shift ; config_tail="$1" ;;
      --) shift ; break ;;
      -*) echo "argv error: $1" ; exit 2 ;;
       *) break ;;
    esac
    shift
  done
  local pattern
  for pattern in "$@"; do
    echo "$pattern" >> patterns
  done
}

setup() {
  config_fullshutdir="$(readlink -f "$SHUT_PWD/$config_shutdir")"
  if $config_donotruntests; then
    work_func=printtestnames
  else
    work_func=runtestsinshutdir
  fi
  if $config_split; then
    runtestsaveoutput_func=runtestsaveoutputsplit
    printbody_func=printbodysplit
  else
    runtestsaveoutput_func=runtestsaveoutputmerge
    printbody_func=printbodymerge
  fi
  if $config_verbose; then
    printreportpass_func=printreportpass
    printreportfail_func=printreportfail
  elif $config_quiet; then
    printreportpass_func=true
    printreportfail_func=true
  else
    printreportpass_func=true
    printreportfail_func=printreportfail
  fi
}

configthenwork() {
  configfromargv "$@"
  setup
  collectnamesandwork
}

# -----------------------------------------------------------------------------
workcatcherror() {
  configthenwork "$@" 2> workerrorunhandled 3> workerrorhandled
  local exitstatus=$?
  if [ -s workerrorhandled ]; then
    cat workerrorhandled >&2
  fi
  if [ -s workerrorunhandled ]; then
    echo "unhandled error:" >&2
    cat workerrorunhandled >&2
  fi
  return "$exitstatus"
}

# -----------------------------------------------------------------------------
mktemp_tempdir() {
  config_tempdir="$(mktemp -d --tmpdir shuttempdir.XXX 2> /dev/null)" || {
    echo "error creating tempdir" >&2
    echo "cannot continue" >&2
    return 3
  }
}

cd_tempdir() {
  cd -- "$config_tempdir" > /dev/null 2>&1 || {
    echo "failed changing directory to $config_tempdir" >&2
    echo "cannot continue" >&2
    return 3
  }
}

rm_tempdir() {
  rm -r -- "$config_tempdir" > /dev/null 2>&1 || {
    echo "error deleting tempdir" >&2
    echo "not fatal but annoying" >&2
    return 3
  }
}

workintempdir() {
  mktemp_tempdir || return $?
  (
    cd_tempdir || return $?
    workcatcherror "$@"
  )
  local exitstatus=$?
  rm_tempdir || return $?
  return "$exitstatus"
}

# -----------------------------------------------------------------------------
main() {
  workintempdir "$@"
}

main "$@"
