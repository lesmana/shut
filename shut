#! /bin/sh

prefix="test"
donotruntests=false
recursive=false
keepworkdir=false
workdir=

handle_args() {
  while getopts "knrw:" "opt"; do
    case "$opt" in
      k) keepworkdir=true;;
      n) donotruntests=true;;
      r) recursive=true;;
      w) workdir="$OPTARG"; keepworkdir=true;;
      *) exit 1;;
    esac
  done
  shift $(($OPTIND - 1))
  if [ $# -ge 1 ]; then
    prefix="$@"
  fi
}

setup() {
  if [ -n "$workdir" ]; then
    if [ -e "$workdir" ]; then
      rm -rf "$workdir"
    fi
    mkdir -p "$workdir"
  else
    workdir=$(mktemp -d --tmpdir shut.XXXXXXXXXX)
  fi
}

collecttestnames() {
  if $recursive; then
    maxdepth=""
  else
    maxdepth="-maxdepth 1"
  fi
  find -L . $maxdepth -type f -executable -name "$prefix*" | sort
}

report() {
  testname="$1"
  exitstatus="$2"
  echo "================"
  echo "$testname"
  echo "----------------"
  echo "output:"
  sed 's/^/  /'
  echo "----------------"
  echo "exitstatus: $exitstatus"
  echo "FAIL $testname"
  echo "----------------"

}

runtestforreal() {
  testname=$1
  dirname=$(dirname "$testname")
  basename=$(basename "$testname")
  (cd "$dirname"; "./$basename" 2>&1)
  exitstatus=$?
  return $exitstatus
}

runtest() {
  testname=$1
  output="$(runtestforreal "$testname" 2>&1)"
  exitstatus=$?
  if [ $exitstatus -ne 0 ]; then
    echo "$output" | report "$testname" "$exitstatus"
  fi
  return $exitstatus
}

runtests() {
  fail=0

  while read testname; do
    if $donotruntests; then
      echo "$testname"
    else
      runtest "$testname" || fail=1
    fi
  done

  return $fail
}

cleanup() {
  if ! $keepworkdir; then
    rm -rf "$workdir"
  fi
}

main() {
  handle_args "$@"
  setup
  collecttestnames | runtests
  success=$?
  cleanup
  return $success
}

main "$@"
