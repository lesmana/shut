#! /bin/sh

prefix="test"
donotruntests=false
verbose=false
shutdir="shutdir"
delete=false
split=false
SHUT_PWD=$PWD

configfromargv() {
  while getopts "d:nvfx" "opt"; do
    case "$opt" in
      d) shutdir="$OPTARG";;
      f) delete=true;;
      n) donotruntests=true;;
      v) verbose=true;;
      x) split=true;;
      *) exit 1;;
    esac
  done
  shift $(($OPTIND - 1))
  if [ $# -ge 1 ]; then
    prefix="$@"
  fi
}

setup() {
  fullshutdir=$(readlink -f "$shutdir")
  if $delete; then
    candeleteshutdir=true
  else
    candeleteshutdir=trueifshutdirdoesnotexists
  fi
  if $donotruntests; then
    shutaction=printtestnames
  else
    shutaction=runtests
  fi
  if $split; then
    runtestsaveoutput=runtestsaveoutputsplit
    if $verbose; then
      printoutputpass=printoutputpasssplit
      printoutputfail=printoutputfailsplit
    else
      printoutputpass=true
      printoutputfail=printoutputfailsplit
    fi
  else
    runtestsaveoutput=runtestsaveoutputmerge
    if $verbose; then
      printoutputpass=printoutputpassmerge
      printoutputfail=printoutputfailmerge
    else
      printoutputpass=true
      printoutputfail=printoutputfailmerge
    fi
  fi
}

collecttestnames() {
  find -type d -name "$shutdir" -prune -o \
        -type f -executable -name "$prefix*" -print | sort
}

trueifshutdirdoesnotexists() {
  [ ! -e "$fullshutdir" ]
}

runtestinworkdir() {
  testname=$1
  fulltestname=$(readlink -f "$SHUT_PWD/$testname")
  mkdir workdir
  (
    cd workdir
    export SHUT_PWD
    export SHUT_TEST="$fulltestname"
    export SHUT_TESTPWD="$PWD"
    "$fulltestname"
  )
  exitstatus=$?
  return $exitstatus
}

runtestsaveoutputsplit() {
  testname=$1
  runtestinworkdir "$testname" > stdout 2> stderr
}

runtestsaveoutputmerge() {
  testname=$1
  runtestinworkdir "$testname" > output 2>&1
}

runtestsaveoutputexitstatus() {
  testname=$1
  $runtestsaveoutput "$testname"
  exitstatus=$?
  echo $exitstatus > exitstatus
  return $exitstatus
}

decoratehead() {
  testname=$1
  echo "================"
  echo "$testname"
  echo "----------------"
}

decoratebody() {
  echo "output:"
  sed 's/^/  /'
}

decoratetail() {
  testname=$1
  exitstatus=$2
  echo "----------------"
  echo "exitstatus: $exitstatus"
  if [ $exitstatus -eq 0 ]; then
    echo "PASS $testname"
  else
    echo "FAIL $testname"
  fi
  echo "----------------"
}

decorate() {
  testname=$1
  exitstatus=$2
  decoratehead "$testname"
  decoratebody
  decoratetail "$testname" "$exitstatus"
}

printoutputpasssplit() {
  testname=$1
  cat stdout stderr | decorate "$testname" 0
}

printoutputfailsplit() {
  testname=$1
  cat stdout stderr | decorate "$testname" 1
}

printoutputpassmerge() {
  testname=$1
  decorate "$testname" 0 < output
}

printoutputfailmerge() {
  testname=$1
  decorate "$testname" 1 < output
}

runtestandprintoutput() {
  testname=$1
  runtestsaveoutputexitstatus "$testname"
  exitstatus=$?
  if [ $exitstatus -eq 0 ]; then
    $printoutputpass "$testname"
  else
    $printoutputfail "$testname"
  fi
  return $exitstatus
}

runtestintestdir() {
  testname=$1
  testdir=$testname.dir
  mkdir -p "$testdir"
  (
    cd "$testdir";
    runtestandprintoutput "$testname"
  )
}

runtestsandlog() {
  touch pass fail
  while read testname; do
    if runtestintestdir "$testname"; then
      echo "$testname" >> pass
    else
      echo "$testname" >> fail
    fi
  done < tests
}

printsummary() {
  if [ -s fail ]; then
    echo "failed tests:"
    cat fail
    echo "----------------"
    exitstatus=1
  fi
  wc -l tests pass fail | {
    read runcount ignorefilename
    read passcount ignorefilename
    read failcount ignorefilename
    read ignoretotal
    echo "run: $runcount pass: $passcount fail: $failcount"
  }
  return $exitstatus
}

runtestsinshutdir() {
  testnames=$1
  mkdir -p "$fullshutdir"
  (
    cd "$fullshutdir"
    cp "$testnames" tests
    runtestsandlog
    printsummary
  )
}

runtests() {
  testnames=$1
  if $candeleteshutdir; then
    rm -rf "$fullshutdir"
    runtestsinshutdir "$testnames"
    exitstatus=$?
  else
    echo "name exists: $shutdir" >&2
    echo "will not overwrite" >&2
    echo "use -f to overwrite" >&2
    exitstatus=2
  fi
  return $exitstatus
}

printtestnames() {
  testnames=$1
  cat "$testnames"
  wc -l "$testnames" | {
    read count ignorefilename
    echo "would run: $count"
  }
}

doshut() {
  testnames=$(mktemp --tmpdir shuttestnames.XXX)
  collecttestnames > "$testnames"
  if [ -s "$testnames" ]; then
    $shutaction "$testnames"
    exitstatus=$?
  else
    echo "no tests found"
    exitstatus=3
  fi
  rm "$testnames"
  return $exitstatus
}

main() {
  configfromargv "$@"
  setup
  doshut
  exitstatus=$?
  return $exitstatus
}

main "$@"
